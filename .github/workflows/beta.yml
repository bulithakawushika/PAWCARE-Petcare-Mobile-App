name: Flutter CI/CD with Android Testing
on:
  push:
    branches: [beta]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
      
      - name: Cache Flutter Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-flutter-
      
      - name: Install dependencies
        run: flutter pub get
      
      - name: Decode google-services.json from secret
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          mkdir -p android/app
          echo "$GOOGLE_SERVICES_JSON" | base64 --decode > android/app/google-services.json
      
      - name: Run Flutter unit tests
        run: flutter test --coverage
      
      - name: Check if integration tests exist
        id: check_integration_tests
        run: |
          if [ -d "integration_test" ] && [ "$(ls -A integration_test)" ]; then
            echo "has_integration_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_integration_tests=false" >> $GITHUB_OUTPUT
            echo "No integration tests found, skipping emulator setup"
          fi
      
      - name: Enable KVM group perms
        if: steps.check_integration_tests.outputs.has_integration_tests == 'true'
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
      
      - name: Set up Android SDK
        if: steps.check_integration_tests.outputs.has_integration_tests == 'true'
        uses: android-actions/setup-android@v3
      
      - name: Run integration tests on emulator
        if: steps.check_integration_tests.outputs.has_integration_tests == 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          arch: x86_64
          profile: Nexus 6
          script: flutter test integration_test
      
      - name: Build APK
        run: flutter build apk --release
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release.apk
          path: build/app/outputs/flutter-apk/app-release.apk
